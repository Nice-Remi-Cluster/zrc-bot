# maimai_cn 插件使用文档

## 插件简介

maimai_cn 插件是一个专为舞萌DX（maimai DX）国区玩家设计的账号管理和成绩查询插件。该插件支持多查分器平台集成，提供B50（Best 50）成绩查询功能，并配备丰富的快捷指令以提升用户体验。

### 核心特性
- 多账号绑定管理
- 多查分器平台支持（水鱼查分器、落雪查分器）
- B50成绩查询与可视化
- 智能快捷指令系统
- 数据安全加密存储

## 主要功能

### 1. 账号绑定管理

#### 绑定国区舞萌账号
```
/maimai_cn bind <sgwcmaid> [bind_name]
```

**参数说明：**
- `sgwcmaid`: 舞萌DX账号的SGWCMAID（世嘉游戏中心账号ID）
- `bind_name`: 可选的自定义绑定名称，用于区分多个账号

**快捷指令：**
- `绑定舞萌 <sgwcmaid> [bind_name]`

**使用示例：**
```
绑定舞萌 123456789 主号
绑定舞萌 987654321 小号
```

#### 绑定水鱼查分器
```
/maimai_cn bind_diving_fish <username> <password>
```

**参数说明：**
- `username`: 水鱼查分器（Diving Fish）平台的注册用户名
- `password`: 对应的登录密码（将进行加密存储）

**快捷指令：**
- `绑定水鱼 <username> <password>`
- `帮我绑水鱼 <username> <password>`
- `帮我绑定水鱼 <username> <password>`
- `绑定divingfish <username> <password>`
- `帮我绑divingfish <username> <password>`
- `帮我绑定divingfish <username> <password>`

**使用示例：**
```
绑定水鱼 myusername mypassword
帮我绑定divingfish player123 pass456
```

#### 绑定落雪查分器
```
/maimai_cn bind_luoxue <friend_code>
```

**参数说明：**
- `friend_code`: 落雪查分器（LXNS）平台的好友邀请码

**快捷指令：**
- `绑定落雪 <friend_code>`
- `帮我绑落雪 <friend_code>`
- `帮我绑定落雪 <friend_code>`
- `绑定lxns <friend_code>`
- `帮我绑lxns <friend_code>`
- `帮我绑定lxns <friend_code>`

**使用示例：**
```
绑定落雪 ABC123DEF
帮我绑定lxns XYZ789GHI
```

### 2. 账号管理

#### 查看已绑定账号
```
/maimai_cn list
```

显示当前用户所有已绑定的舞萌DX账号和查分器信息，包括绑定ID、账号名称、绑定状态等。

**快捷指令：**
- `我都绑了什么`
- `查绑定`

**使用示例：**
```
用户: 我都绑了什么
机器人: 您当前绑定的账号：
1. [主号] SGWCMAID: 123456789
2. [小号] SGWCMAID: 987654321
查分器: 水鱼查分器 (已绑定), 落雪查分器 (已绑定)
```

#### 设置首选账号
```
/maimai_cn set_primary <bind_id>
```

**参数说明：**
- `bind_id`: 绑定账号的唯一标识ID（通过list命令查看）

**快捷指令：**
- `设置首选 <bind_id>`
- `切换首选 <bind_id>`
- `切到 <bind_id>`
- `使用 <bind_id>`

**使用示例：**
```
切到 2
设置首选 1
使用 2
```

### 3. 成绩查询与更新

#### 更新查分器数据
```
/maimai_cn update [source]
```

从指定的查分器平台同步最新的成绩数据到本地数据库。建议在游戏后及时更新以获取最新成绩。

**参数说明：**
- `source`: 可选参数，指定数据源（水鱼/落雪）。不指定时将更新所有已绑定的查分器

**快捷指令：**
- `更新b50`
- `更新查分器`
- `更新b50 <source>`
- `更新<source>b50`
- `更新查分器 <source>`
- `更新<source>查分器`

**使用示例：**
```
更新b50              # 更新所有查分器数据
更新水鱼b50          # 仅更新水鱼查分器数据
更新落雪查分器        # 仅更新落雪查分器数据
```

#### 查询B50成绩
```
/maimai_cn b50 [source]
```

生成并显示当前账号的B50（Best 50）成绩图表，包括B35（Best 35）和B15（Recent 15）成绩。

**参数说明：**
- `source`: 可选参数，指定查询的数据源（水鱼/落雪）。默认使用水鱼查分器数据

**快捷指令：**
- `b50` （默认使用水鱼数据源）
- `查<source>b50`
- `看<source>b50`
- `查b50 <source>`
- `看b50 <source>`
- `查b50` （默认使用水鱼数据源）

**使用示例：**
```
b50                  # 查询默认数据源的B50成绩
查水鱼b50            # 查询水鱼查分器的B50成绩
看落雪b50            # 查询落雪查分器的B50成绩
```

## 使用示例

### 基本使用流程

1. **绑定舞萌账号**
   ```
   绑定舞萌 123456789 我的主号
   ```

2. **绑定查分器**
   ```
   绑定落雪 ABC123
   绑定水鱼 myusername mypassword
   帮我绑定divingfish myusername mypassword
   ```

3. **查看绑定状态**
   ```
   我都绑了什么
   ```

4. **更新数据**
   ```
   更新b50
   更新落雪b50
   ```

5. **查询成绩**
   ```
   b50
   查落雪b50
   ```

### 高级功能

#### 多账号管理
当你绑定了多个舞萌账号时，可以通过设置首选账号来切换：
```
切到 2  # 切换到ID为2的绑定账号
```

#### 指定数据源查询
```
查水鱼b50    # 使用水鱼查分器数据
查落雪b50    # 使用落雪查分器数据
```

## 技术原理

### 数据存储架构
插件采用SQLAlchemy ORM框架进行数据持久化管理，确保数据的一致性和安全性。

**核心数据表：**
- `MaimaiBinding`: 存储用户的舞萌DX账号绑定信息
  - 支持多账号绑定管理
  - 首选账号设置机制
  - 绑定状态跟踪
- `UserData`: 用户基础信息表
- `ScoreCache`: 成绩数据缓存表

### 查分器平台集成

#### 水鱼查分器（Diving Fish）
- **认证方式**: 用户名/密码认证
- **数据获取**: RESTful API接口
- **数据格式**: JSON格式的详细成绩数据
- **更新频率**: 支持实时数据同步

#### 落雪查分器（LXNS）
- **认证方式**: 好友码验证
- **数据获取**: 专用API接口
- **数据格式**: 标准化成绩数据结构
- **特色功能**: 社交化成绩分享

### 成绩数据处理

#### 数据标准化
- 统一不同查分器的数据格式
- 标准化难度等级和成绩评级
- 自动计算Rating和DX Rating

#### 图像生成
- 使用PIL（Python Imaging Library）生成B50成绩图表
- 支持自定义主题和样式
- 高质量图像输出（PNG格式）

#### 缓存机制
- 智能缓存策略减少API调用
- 定期清理过期数据
- 支持手动刷新缓存

## 注意事项

### 安全性考虑
1. **密码保护**: 查分器登录密码采用AES加密算法存储，确保账号安全
2. **权限控制**: 仅授权用户可访问自己的绑定账号信息
3. **数据传输**: 所有API调用均使用HTTPS加密传输
4. **敏感信息**: 不会记录或显示完整的密码信息

### 使用建议
1. **定期更新**: 建议游戏后及时更新查分器数据，确保成绩准确性
2. **多账号管理**: 合理使用绑定名称区分不同账号，便于管理
3. **网络环境**: 确保网络连接稳定，避免数据同步失败
4. **查分器状态**: 关注查分器平台的维护公告，避免在维护期间使用

### 故障排除
1. **绑定失败**: 检查SGWCMAID格式是否正确，确认账号状态正常
2. **数据同步失败**: 验证查分器账号密码，检查网络连接
3. **图片生成失败**: 确保已更新最新成绩数据，检查系统资源
4. **二维码过期**: 重新获取有效的SGWCMAID并重新绑定

## 常见问题解答

### 绑定相关问题

**Q: 绑定时提示"二维码已过期"怎么办？**
A: SGWCMAID具有时效性，请重新登录舞萌DX游戏获取最新的SGWCMAID，然后重新执行绑定命令。

**Q: 可以绑定多个舞萌账号吗？**
A: 是的，插件支持绑定多个舞萌DX账号。使用不同的绑定名称进行区分，通过首选账号设置进行切换。

**Q: 查分器密码忘记了怎么办？**
A: 请前往对应查分器平台（水鱼查分器或落雪查分器）重置密码，然后重新绑定。

### 功能使用问题

**Q: 如何切换不同的绑定账号？**
A: 使用 `切到 <bind_id>` 命令设置首选账号。先通过 `我都绑了什么` 查看账号ID，再进行切换。

**Q: 支持哪些查分器平台？**
A: 目前支持水鱼查分器（Diving Fish）和落雪查分器（LXNS）两个主流平台，后续将根据需求扩展更多平台。

**Q: B50图片生成失败怎么办？**
A: 请按以下步骤排查：
1. 确认已正确绑定查分器账号
2. 执行数据更新命令同步最新成绩
3. 检查网络连接是否稳定
4. 如问题持续，请联系管理员

**Q: 数据更新频率有限制吗？**
A: 为避免对查分器平台造成压力，建议合理控制更新频率。一般情况下，每次游戏结束后更新一次即可。

### 技术支持

**Q: 插件支持哪些舞萌DX版本？**
A: 插件支持当前所有舞萌DX国区版本，包括最新的歌曲和难度数据。

**Q: 成绩数据的准确性如何保证？**
A: 插件直接从官方认可的查分器平台获取数据，确保成绩的准确性和时效性。